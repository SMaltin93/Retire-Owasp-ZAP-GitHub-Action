

name: RetireJS Scan

on:
  push:
    branches:
      - test-sam
 #pull_request: # 

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 

    - name: Install dependencies
      uses: bahmutov/npm-install@v1

    - name: Install RetireJS
      run: npm install -g retire
      # run scan and upload the report
    - name: Run RetireJS Scan
      id: retirejs-scan
      run: retire --outputformat json --outputpath retirejs-report.json --verbose 
        

      # upload the report directly to the repository


   # Step 6: Set up Python for running your custom script
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

      # Step 7: Install the requests library
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install requests

 # Step 7: Run the Python script to check vulnerabilities and send the Slack message if found
    - name: Run Vulnerability Check Python Script
      run: python3 check_vulnerabilities.py
      env: # this will set the environment variables for the script 
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        Author: ${{ github.actor }}
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref }}
        Commit: ${{ github.sha }}

# Push to GitHub job
  push-code:
    needs: security-scan  # Only run this job if the security-scan job succeeds
    runs-on: ubuntu-latest
    if: success()  # This condition ensures this step only runs if all previous steps were successful

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Push Code
      run: |
        git config --global user.email "
        git config --global user.name "GitHub Actions"
        git add .
        git commit -m "RetireJS Scan Report"
        git push


        
  # Step 8: Upload RetireJS Report
    - name: Upload RetireJS Report
      uses: actions/upload-artifact@v4
      with:
        name: retirejs-report
        path: retirejs-report.json

 