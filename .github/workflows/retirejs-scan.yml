

name: RetireJS Scan

on:
  push:
    branches:
      - test-sam
 #pull_request: # 

permissions:
  contents: write

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 

    - name: Install dependencies
      uses: bahmutov/npm-install@v1

    - name: Install RetireJS
      run: npm install -g retire
      # run scan and upload the report
    - name: Run RetireJS Scan
      run: |
        retire --outputformat json --outputpath retirejs-report.json --verbose --exitwith 0

      # upload the report directly to the repository


   # Step 6: Set up Python for running your custom script
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

      # Step 7: Install the requests library
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install requests

  # upload the report directly to the repository
    - name: Upload RetireJS Report
      uses: actions/upload-artifact@v4
      with:
        name: retirejs-report
        path: retirejs-report.json

 # Step 7: Run the Python script to check vulnerabilities and send the Slack message if found
    - name: Run Vulnerability Check Python Script
      run: python3 check_vulnerabilities.py
      env: # this will set the environment variables for the script 
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        Author: ${{ github.actor }}
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref }}
        Commit: ${{ github.sha }}
  # tag the commit with the scan results
    - name: Tag the commit with the scan results
      if: success()
      run: |
        git tag -f safe-commit
        git push origin safe-commit --force
 
# Push to GitHub job
  push-code:
    needs: security-scan  # Only run this job if the security-scan job succeeds ..
    runs-on: ubuntu-latest
    if: failure()   

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Reset to the last commit
      run: |
        git reset --hard safe-commit 
        git push origin test-sam --force


  
    

  
    
    


 