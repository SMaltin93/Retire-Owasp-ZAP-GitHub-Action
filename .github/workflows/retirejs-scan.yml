name: Pre-deploy Vulnerability Scan

on:
  push:
    branches:
      - test-sam
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Dependencies
      run: npm install

    - name: Start Local Server
      run: |
        nohup node server.js &  # Serve your app locally for ZAP to scan
        sleep 5                 # Give the server some time to start

    - name: Run OWASP ZAP Baseline Scan
      run: |
        docker run -v ${PWD}:/zap/wrk/ --user root -t zaproxy/zap-stable zap-baseline.py \
        -t http://localhost:8888/ -r zap-report.html -x zap-report.xml -I

    - name: Install RetireJS
      run: npm install -g retire

    - name: Run RetireJS Scan
      run: retire --outputformat json --outputpath retirejs-report.json

    - name: Check RetireJS Report for High Vulnerabilities
      run: |
        if grep -q '"severity": "high"' retirejs-report.json; then
          echo "High vulnerability detected by RetireJS!";
          exit 1;
        else
          echo "No high vulnerabilities found in RetireJS report.";
        fi

    - name: Check ZAP Report for High Vulnerabilities
      run: |
        if grep -q '<riskcode>3</riskcode>' zap-report.xml; then
          echo "High vulnerability detected by OWASP ZAP!";
          exit 1;
        else
          echo "No high vulnerabilities found in ZAP report.";
        fi

    - name: Deploy to GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.TOKEN }}
        publish_dir: ./  # Publish your directory to GitHub Pages

    - name: Upload RetireJS and ZAP Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          retirejs-report.json
          zap-report.html
          zap-report.xml
